<!DOCTYPE html>
<html lang="zh-Hant-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Á©øÊ¢≠Â∑¥Â£´ÊôÇÂàªË°® | Shuttle Bus Schedule</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöå</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@300;400;500;700;900&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ========== RESET & VARS ========== */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f8f9fa;--bg2:#ffffff;
  --glass:rgba(0,0,0,0.03);--glass-h:rgba(0,0,0,0.06);
  --bdr:rgba(0,0,0,0.08);--bdr-l:rgba(0,0,0,0.15);
  --t1:#1e293b;--t2:#334155;--t3:#64748b;--t4:#94a3b8;
  --teal:#14b8a6;--teal-d:rgba(20,184,166,0.1);
  --cyan:#06b6d4;--cyan-d:rgba(6,182,212,0.1);
  --violet:#8b5cf6;--violet-d:rgba(139,92,246,0.1);
  --purple:#a855f7;--purple-d:rgba(168,85,247,0.1);
  --amber:#f59e0b;--amber-d:rgba(245,158,11,0.1);
  --green:#10b981;--red:#ef4444;
}
html{scroll-behavior:smooth}
body{
  font-family:'Noto Sans HK','Inter',-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  background-image:
    radial-gradient(ellipse at 10% 40%,rgba(20,184,166,.05) 0%,transparent 55%),
    radial-gradient(ellipse at 90% 15%,rgba(139,92,246,.04) 0%,transparent 55%),
    radial-gradient(ellipse at 50% 95%,rgba(245,158,11,.03) 0%,transparent 50%);
  background-attachment:fixed;color:var(--t2);min-height:100vh;
  -webkit-font-smoothing:antialiased;
}

/* ========== TOP BAR ========== */
.topbar{
  position:sticky;top:0;z-index:100;
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 16px;
  background:rgba(248,249,250,.95);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-bottom:1px solid var(--bdr);
}
.topbar-brand{display:flex;align-items:center;gap:8px;font-weight:700;font-size:14px;color:var(--t1)}
.bus-emoji{font-size:20px;display:inline-block;animation:wiggle 3s ease-in-out infinite}
@keyframes wiggle{0%,100%{transform:translateX(0) rotate(0)}25%{transform:translateX(3px) rotate(1deg)}75%{transform:translateX(-2px) rotate(-.5deg)}}
.topbar-r{display:flex;align-items:center;gap:10px}
.lang-btn,.font-btn{
  background:var(--glass);border:1px solid var(--bdr-l);color:var(--t2);
  padding:5px 14px;border-radius:18px;cursor:pointer;font-size:12px;font-weight:600;
  letter-spacing:.3px;transition:all .25s ease;font-family:inherit;
}
.lang-btn:hover,.font-btn:hover{background:var(--glass-h);color:var(--t1);border-color:var(--bdr-l)}
.font-btn{background:#f59e0b;color:#fff;border-color:#f59e0b;font-size:13px;padding:6px 15px}
.font-btn:hover{background:#d97706;border-color:#d97706}
.clock{font-variant-numeric:tabular-nums;font-weight:600;font-size:13px;color:var(--t1);letter-spacing:.8px}

/* ========== HERO ========== */
.hero{
  position:relative;overflow:hidden;padding:24px 16px 36px;text-align:center;
  background:linear-gradient(160deg,#e0f2fe 0%,#ddd6fe 40%,#fef3c7 100%);
}
.hero::before{
  content:'';position:absolute;inset:0;pointer-events:none;
  background:
    radial-gradient(circle at 30% 60%,rgba(20,184,166,.08) 0%,transparent 40%),
    radial-gradient(circle at 70% 30%,rgba(139,92,246,.08) 0%,transparent 40%);
}
.hero-mountain{position:absolute;bottom:0;left:0;width:100%;opacity:.12;pointer-events:none}
.hero-title{
  font-size:clamp(22px,5vw,36px);font-weight:900;line-height:1.2;position:relative;
  background:linear-gradient(135deg,#1e293b 0%,#334155 50%,#475569 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.hero-sub{
  margin-top:8px;font-size:clamp(11px,2.5vw,14px);color:var(--t3);
  font-weight:400;letter-spacing:.2px;position:relative;
}
.hero-meta{margin-top:16px;display:flex;justify-content:center;align-items:center;gap:8px;flex-wrap:wrap;position:relative}
.day-badge{
  display:inline-flex;align-items:center;gap:4px;
  padding:5px 14px;border-radius:18px;font-size:12px;font-weight:600;
  cursor:pointer;transition:all .25s ease;user-select:none;
}
.day-badge.on{background:var(--amber-d);color:var(--amber);border:1px solid rgba(245,158,11,.4)}
.day-badge.off{background:var(--glass);color:var(--t4);border:1px solid var(--bdr)}
.day-badge.off:hover{color:var(--t3);border-color:var(--bdr-l)}
.day-auto{font-size:10px;color:var(--t4);margin-top:4px;width:100%;text-align:center}
.day-auto a{color:var(--t3);cursor:pointer;text-decoration:underline;text-underline-offset:2px}

/* ========== WAVE ========== */
.wave-wrap{position:relative;margin-top:-2px;line-height:0}
.wave-wrap svg{display:block;width:100%}
.wave-wrap path{fill:#f8f9fa}

/* ========== DASHBOARD ========== */
.dashboard{max-width:1100px;margin:-20px auto 0;padding:0 12px;position:relative;z-index:10}
.dash-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
@media(max-width:720px){.dash-grid{grid-template-columns:1fr}}
.route-card{
  position:relative;overflow:hidden;
  background:rgba(255,255,255,.85);
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:1px solid var(--bdr);border-radius:14px;padding:12px;
  cursor:pointer;transition:all .35s cubic-bezier(.4,0,.2,1);
}
.route-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--rc);opacity:.85}
.route-card:hover{
  background:rgba(255,255,255,.98);border-color:var(--bdr-l);
  transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.1);
}
.card-head{display:flex;justify-content:space-between;align-items:flex-start;gap:6px}
.card-dir{font-size:13px;font-weight:700;color:var(--t1);line-height:1.3}
.card-dir .arr{color:var(--rc);margin:0 2px}
.card-tag{
  font-size:9px;color:var(--t4);background:var(--glass);padding:2px 8px;
  border-radius:8px;white-space:nowrap;border:1px solid var(--bdr);flex-shrink:0;
}
.card-transit{
  margin-top:8px;display:flex;align-items:center;gap:3px;font-size:9px;
  color:var(--green);background:rgba(16,185,129,.08);
  padding:5px 8px;border-radius:6px;border:1px solid rgba(16,185,129,.2);
}
.card-transit b{font-variant-numeric:tabular-nums}
.next-label{
  display:flex;align-items:center;gap:5px;margin-top:10px;
  font-size:8px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:1px;
}
.pulse{
  width:6px;height:6px;border-radius:50%;background:var(--rc);
  box-shadow:0 0 6px var(--rc);animation:pDot 2s ease-in-out infinite;
}
@keyframes pDot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.45;transform:scale(.75)}}
.next-time{
  font-size:clamp(24px,5.5vw,38px);font-weight:800;color:var(--t1);
  margin-top:1px;font-variant-numeric:tabular-nums;letter-spacing:1.2px;line-height:1.05;
}
.next-time .star{font-size:12px;color:var(--amber);vertical-align:super;margin-left:1px}
.countdown{font-size:11px;font-weight:600;margin-top:2px}
.cd-soon{color:var(--amber)}
.cd-now{color:var(--green);animation:pDot 1s ease-in-out infinite}
.cd-norm{color:var(--t3)}
.card-arr{margin-top:7px;font-size:9px;color:var(--t4);display:flex;align-items:center;gap:3px}
.card-arr b{color:var(--t3);font-weight:600;font-variant-numeric:tabular-nums}
.card-later{margin-top:6px;padding-top:6px;border-top:1px solid var(--bdr);font-size:9px;color:var(--t4)}
.later-row{display:flex;gap:4px;margin-top:3px;flex-wrap:wrap}
.later-row span{
  background:var(--glass);border:1px solid var(--bdr);
  padding:2px 6px;border-radius:5px;font-size:10px;font-weight:500;
  color:var(--t3);font-variant-numeric:tabular-nums;
}
.card-ended{margin-top:8px;text-align:center;padding:10px 0}
.ended-msg{font-size:11px;color:var(--t4);font-weight:500}
.ended-first{font-size:9px;color:var(--t4);margin-top:3px}
.ended-first b{color:var(--t3)}

/* ========== TIMETABLE ========== */
.tt-section{max-width:1100px;margin:28px auto 0;padding:0 12px}
.sec-title{
  font-size:16px;font-weight:700;color:var(--t1);margin-bottom:12px;
  display:flex;align-items:center;gap:6px;
}
.sec-title::before{content:'';width:3px;height:18px;border-radius:2px;background:var(--violet)}
.tabs{display:flex;gap:6px;overflow-x:auto;padding-bottom:3px;scrollbar-width:none;-ms-overflow-style:none}
.tabs::-webkit-scrollbar{display:none}
.tab{
  flex-shrink:0;padding:7px 14px;border-radius:10px;border:1px solid var(--bdr);
  background:var(--glass);color:var(--t3);font-size:11px;font-weight:600;
  cursor:pointer;transition:all .25s ease;white-space:nowrap;font-family:inherit;
}
.tab:hover{background:var(--glass-h);color:var(--t2)}
.tab.on{font-weight:700}
.tab.on[data-c="teal"]{background:var(--teal-d);color:var(--teal);border-color:rgba(20,184,166,.4)}
.tab.on[data-c="cyan"]{background:var(--cyan-d);color:var(--cyan);border-color:rgba(6,182,212,.4)}
.tab.on[data-c="violet"]{background:var(--violet-d);color:var(--violet);border-color:rgba(139,92,246,.4)}
.tab.on[data-c="purple"]{background:var(--purple-d);color:var(--purple);border-color:rgba(168,85,247,.4)}
.tt-info{margin-top:10px;font-size:11px;color:var(--t3);font-weight:500;margin-bottom:4px}
.legend{display:flex;gap:10px;flex-wrap:wrap;font-size:9px;color:var(--t4);margin-bottom:6px}
.legend span{display:inline-flex;align-items:center;gap:3px}
.legend .dot{width:8px;height:8px;border-radius:2px;display:inline-block}
.time-grid{
  display:flex;flex-wrap:wrap;gap:4px;padding:12px;
  background:rgba(255,255,255,.6);border:1px solid var(--bdr);border-radius:12px;
}
.chip{
  display:inline-flex;align-items:center;justify-content:center;gap:2px;
  padding:6px 10px;border-radius:8px;font-size:12px;font-weight:500;
  font-variant-numeric:tabular-nums;background:var(--glass);
  border:1px solid var(--bdr);color:var(--t2);transition:all .2s ease;
  min-width:60px;
}
.chip.past{opacity:.3;color:var(--t4)}
.chip.next{
  background:var(--amber-d);color:var(--amber);border-color:rgba(245,158,11,.5);
  box-shadow:0 0 16px rgba(245,158,11,.2);font-weight:700;
  animation:glow 2.5s ease-in-out infinite;
}
@keyframes glow{0%,100%{box-shadow:0 0 16px rgba(245,158,11,.2)}50%{box-shadow:0 0 24px rgba(245,158,11,.35)}}
.chip.transit{background:rgba(16,185,129,.1);color:var(--green);border-color:rgba(16,185,129,.35)}
.chip .s{font-size:7px;color:var(--amber);opacity:.75}

/* ========== FOOTER ========== */
.footer{max-width:1100px;margin:28px auto 0;padding:0 12px 36px}
.notes{background:rgba(255,255,255,.6);border:1px solid var(--bdr);border-radius:12px;padding:14px}
.notes h3{font-size:12px;font-weight:700;color:var(--t3);margin-bottom:6px}
.notes ul{list-style:none}
.notes li{font-size:10px;color:var(--t4);padding:2px 0 2px 12px;position:relative;line-height:1.5}
.notes li::before{content:'‚Ä¢';position:absolute;left:0;color:var(--t4)}
.credits{margin-top:12px;text-align:center;font-size:9px;color:var(--t4)}
.credits a{color:var(--t3);text-decoration:none}

/* ========== FONT SIZE CONTROL ========== */
body.font-large{font-size:110%}
body.font-large .hero-title{font-size:clamp(26px,5.5vw,42px)}
body.font-large .next-time{font-size:clamp(32px,6.5vw,48px)}
body.font-large .chip{font-size:13px;min-width:65px}

/* ========== RESPONSIVE ========== */
@media(max-width:520px){
  .topbar{padding:5px 10px}
  .topbar-r{gap:6px}
  .font-btn{padding:4px 11px;font-size:11px}
  .lang-btn{padding:4px 11px;font-size:11px}
  .hero{padding:18px 10px 28px}
  .hero-title{font-size:clamp(19px,5vw,30px)}
  .hero-sub{font-size:clamp(10px,2.5vw,12px);margin-top:5px}
  .hero-meta{margin-top:10px;gap:6px}
  .day-badge{padding:3px 10px;font-size:10px}
  .day-auto{font-size:8px;margin-top:2px}
  .dashboard{padding:0 8px;margin-top:-12px}
  .dash-grid{gap:6px}
  .route-card{padding:9px;border-radius:12px}
  .card-dir{font-size:11px;line-height:1.2}
  .card-tag{font-size:8px;padding:2px 6px}
  .next-label{margin-top:8px;gap:4px}
  .next-time{font-size:20px;letter-spacing:1px}
  .countdown{font-size:9px}
  .card-arr{font-size:8px;margin-top:5px}
  .card-transit{font-size:8px;margin-top:6px;padding:4px 7px}
  .card-later{font-size:8px;margin-top:4px;padding-top:4px}
  .later-row{gap:3px;margin-top:2px}
  .later-row span{font-size:9px;padding:2px 5px}
  .card-ended{margin-top:6px;padding:8px 0}
  .ended-msg{font-size:10px}
  .ended-first{font-size:8px;margin-top:2px}
  .tab{padding:6px 10px;font-size:10px}
  .time-grid{padding:10px;gap:3px}
  .chip{padding:5px 7px;font-size:11px;min-width:52px}
  .tt-section,.footer{padding:0 8px}
  .clock{display:none}
}
@media(prefers-reduced-motion:reduce){*{animation-duration:.01ms!important}}
</style>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<nav class="topbar">
  <div class="topbar-brand"><span class="bus-emoji">üöå</span><span id="tBrand"></span></div>
  <div class="topbar-r">
    <span class="clock" id="clock"></span>
    <button class="font-btn" id="fontBtn" onclick="toggleFont()" title="ÊîæÂ§ßÂ≠óÈ´î / Enlarge Font">A+</button>
    <button class="lang-btn" id="langBtn" onclick="toggleLang()"></button>
  </div>
</nav>

<!-- ===== HERO ===== -->
<section class="hero">
  <!-- Mountain silhouette -->
  <svg class="hero-mountain" viewBox="0 0 1440 220" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M0,220 L0,180 Q100,120 200,150 Q320,60 440,110 Q520,30 640,80 Q720,10 820,70 Q920,20 1020,90 Q1120,40 1200,100 Q1300,60 1440,130 L1440,220Z" fill="#1e293b"/>
  </svg>
  <h1 class="hero-title" id="hTitle"></h1>
  <p class="hero-sub" id="hSub"></p>
  <div class="hero-meta" id="hMeta"></div>
</section>

<!-- ===== WAVE ===== -->
<div class="wave-wrap">
  <svg viewBox="0 0 1440 54" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M0,27 C360,54 720,0 1080,27 C1260,40 1380,20 1440,27 L1440,54 L0,54Z" fill="#f8f9fa"/>
  </svg>
</div>

<!-- ===== DASHBOARD ===== -->
<section class="dashboard"><div class="dash-grid" id="grid"></div></section>

<!-- ===== TIMETABLE ===== -->
<section class="tt-section">
  <div class="sec-title" id="secT"></div>
  <div class="tabs" id="tabs"></div>
  <div id="ttBody"></div>
</section>

<!-- ===== FOOTER ===== -->
<section class="footer">
  <div class="notes" id="notes"></div>
  <div class="credits">
    Data source: Symphony Bay Shuttle Bus Time Schedule ¬∑
    <a href="https://github.com/hkbus/hk-bus-crawling" target="_blank" rel="noopener">hkbus/hk-bus-crawling</a><br>
    <span id="contactInfo"></span>
  </div>
</section>

<script>
/* ==============================================================
   SCHEDULE DATA ‚Äî loaded from shuttle_bus_schedule.json
   ============================================================== */
const ROUTE_META=[
  {id:'VC_to_SC',color:'teal',tr:10,zh:{f:'Âá±Âº¶Â±Ö',t:'Êñ∞Ê∏ØÂüé',a:'È¶¨ÈûçÂ±±'},en:{f:'Villa Concerto',t:'Sunshine City',a:'Ma On Shan'}},
  {id:'SC_to_VC',color:'cyan',tr:10,zh:{f:'Êñ∞Ê∏ØÂüé',t:'Âá±Âº¶Â±Ö',a:'È¶¨ÈûçÂ±±'},en:{f:'Sunshine City',t:'Villa Concerto',a:'Ma On Shan'}},
  {id:'VC_to_NTP',color:'violet',tr:20,zh:{f:'Âá±Âº¶Â±Ö',t:'Êñ∞ÂüéÂ∏ÇÂª£Â†¥',a:'Ê≤ôÁî∞'},en:{f:'Villa Concerto',t:'New Town Plaza',a:'Sha Tin'}},
  {id:'NTP_to_VC',color:'purple',tr:20,zh:{f:'Êñ∞ÂüéÂ∏ÇÂª£Â†¥',t:'Âá±Âº¶Â±Ö',a:'Ê≤ôÁî∞'},en:{f:'New Town Plaza',t:'Villa Concerto',a:'Sha Tin'}}
];
function flattenTimes(grid){
  // Defensive checks: ensure grid is an array of (possibly ragged) rows
  if (!Array.isArray(grid) || grid.length === 0) return [];

  // Compute the maximum column count among array rows
  let cols = 0;
  for (let i = 0; i < grid.length; i++) {
    const row = grid[i];
    if (Array.isArray(row) && row.length > cols) {
      cols = row.length;
    }
  }
  if (cols === 0) return [];

  const res = [];
  // Expected time format: optional '*' followed by HH:MM (24-hour)
  const TIME_RE = /^\*?(?:[01]\d|2[0-3]):[0-5]\d$/;

  for (let c = 0; c < cols; c++) {
    for (let r = 0; r < grid.length; r++) {
      const row = grid[r];
      if (!Array.isArray(row)) continue;
      const v = row[c];
      if (typeof v !== 'string') continue;
      if (v === '----') continue;
      if (!TIME_RE.test(v)) continue;
      res.push(v);
    }
  }
  return res;
}
let R=[];

/* ==============================================================
   LOCALISATION
   ============================================================== */
const L={
zh:{brand:'Á©øÊ¢≠Â∑¥Â£´',title:'Á©øÊ¢≠Â∑¥Â£´ÊôÇÂàªË°®',
 sub:'Âá±Âº¶Â±Ö ‚Üî Êñ∞Ê∏ØÂüéÔºàÈ¶¨ÈûçÂ±±ÔºâÔºè Êñ∞ÂüéÂ∏ÇÂª£Â†¥ÔºàÊ≤ôÁî∞Ôºâ',
 wd:'Âπ≥Êó•',we:'ÂÅáÊó•',wdF:'ÊòüÊúü‰∏ÄËá≥‰∫îÔºàÂÖ¨ÁúæÂÅáÊúüÈô§Â§ñÔºâ',weF:'ÊòüÊúüÂÖ≠„ÄÅÊó•ÂèäÂÖ¨ÁúæÂÅáÊúü',
 auto:'Ëá™ÂãïÂÅµÊ∏¨',reset:'‚Ü© ÈáçË®≠ÁÇ∫Ëá™Âãï',tap:'ÈªûÊìäÂàáÊèõ',
 next:'‰∏ã‰∏ÄÁè≠',inMin:'ÂàÜÈêòÂæåÂá∫Áôº',soon:'Âç≥Â∞áÂá∫Áôº',
 ended:'‰ªäÊó•ÊúçÂãôÂ∑≤ÁµêÊùü',tmr:'ÊòéÊó•È¶ñÁè≠Ëªä',
 eta:'È†êË®àÂà∞ÈÅî',ride:'ÂàÜÈêòËªäÁ®ã',after:'‰πãÂæå',
 fullTT:'ÂÆåÊï¥ÊôÇÂàªË°®',notes:'ÂÇôË®ª',
 n1:'Ê®ôÁ§∫ ‚òÖ ‰πãÁè≠Ê¨°ÁÇ∫ÂéüÊôÇÈñìË°®ÊòüËôüÁè≠Ê¨°„ÄÇ',
 n2:'Áè≠Ê¨°ÊàñÊúÉÂõ†ÊáâÂØ¶Èöõ‰∫§ÈÄöÊÉÖÊ≥ÅË™øÊï¥„ÄÇ',
 n3:'Headway would be adjusted subject to actual traffic condition.',
 n4:'Ê≠§Á©øÊ¢≠Â∑¥Â£´ÊúçÂãôÂ∑≤Áç≤ÈÅãËº∏ÁΩ≤ÊâπÂáÜÔºåÂ∑¥Â£´Ë∑ØÁ∑öÁ∑®ËôüÁÇ∫ NR524„ÄÇ',
 n5:'ÂæÄÊñ∞ÂüéÂ∏ÇÂª£Â†¥Á∂ìÊñ∞Ê∏ØÂüé„ÄÇ',
 btn:'EN',transit:'Ë°åÈßõ‰∏≠',to:'‚Üí',
 lgNx:'‰∏ã‰∏ÄÁè≠',lgTr:'Ë°åÈßõ‰∏≠',lgDep:'Â∑≤ÈñãÂá∫',lgSp:'ÁâπÂà•Áè≠Ê¨°',
 days:['ÊòüÊúüÊó•','ÊòüÊúü‰∏Ä','ÊòüÊúü‰∫å','ÊòüÊúü‰∏â','ÊòüÊúüÂõõ','ÊòüÊúü‰∫î','ÊòüÊúüÂÖ≠']},
en:{brand:'Shuttle Bus',title:'Shuttle Bus Timetable',
 sub:'Villa Concerto ‚Üî Sunshine City (Ma On Shan) / New Town Plaza (Sha Tin)',
 wd:'Weekday',we:'Weekend',wdF:'Mon ‚Äì Fri (excl. Public Holidays)',weF:'Sat, Sun & Public Holidays',
 auto:'Auto-detect',reset:'‚Ü© Reset to auto',tap:'Tap to switch',
 next:'NEXT BUS',inMin:'min to departure',soon:'Departing now',
 ended:'Service ended for today',tmr:'First bus tomorrow',
 eta:'Est. arrival',ride:'min ride',after:'Then',
 fullTT:'Full Timetable',notes:'Notes',
 n1:'Services marked ‚òÖ are asterisked in the original timetable.',
 n2:'Headway would be adjusted subject to actual traffic condition.',n3:'',
 n4:'This shuttle bus service is approved by the Transport Department with registered route code NR524.',
 n5:'To New Town Plaza via Sunshine City.',
 btn:'‰∏≠Êñá',transit:'In transit',to:'‚Üí',
 lgNx:'Next',lgTr:'In transit',lgDep:'Departed',lgSp:'Special',
 days:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday']}
};

/* ==============================================================
   STATE
   ============================================================== */
let lang='zh',forceDay=null,activeTab='VC_to_SC',largeFont=false;
try{const s=localStorage.getItem('sbLang');if(s==='en'||s==='zh')lang=s}catch(e){}
try{const f=localStorage.getItem('sbLargeFont');if(f==='true')largeFont=true}catch(e){}
if(largeFont)document.body.classList.add('font-large');

/* ==============================================================
   HELPERS
   ============================================================== */
const $=id=>document.getElementById(id);
const T=k=>L[lang][k];
const pad=n=>n.toString().padStart(2,'0');

function hk(){
  const s=new Date().toLocaleString('en-US',{timeZone:'Asia/Hong_Kong'});
  return new Date(s);
}
function hkH(){return hk().getHours()}
function hkM(){return hk().getMinutes()}
function hkS(){return hk().getSeconds()}
function hkD(){return hk().getDay()}
function nowM(){return hkH()*60+hkM()}

function pT(s){
  const sp=s.startsWith('*'),c=s.replace('*',''),p=c.split(':').map(Number);
  return{h:p[0],m:p[1],tot:p[0]*60+p[1],sp,disp:c};
}
function dayType(){
  if(forceDay)return forceDay;
  const d=hkD();return(d===0||d===6)?'we':'wd';
}
function times(r){return dayType()==='wd'?r.wd:r.we}
function nextI(ts){
  const n=nowM(),sec=hkS();
  for(let i=0;i<ts.length;i++){
    const t=pT(ts[i]).tot;
    if(t>n)return i;
    if(t===n&&sec<30)return i;
  }
  return -1;
}
function addM(disp,mins){
  const[h,m]=disp.split(':').map(Number);
  let nm=m+mins,nh=h;
  if(nm>=60){nh+=Math.floor(nm/60);nm%=60}
  if(nh>=24)nh-=24;
  return pad(nh)+':'+pad(nm);
}

const cMap={teal:'var(--teal)',cyan:'var(--cyan)',violet:'var(--violet)',purple:'var(--purple)'};

/* ==============================================================
   RENDER ‚Äî CLOCK
   ============================================================== */
function rClock(){$('clock').textContent=pad(hkH())+':'+pad(hkM())+':'+pad(hkS())}

/* ==============================================================
   RENDER ‚Äî HERO
   ============================================================== */
function rHero(){
  $('tBrand').textContent=T('brand');
  $('hTitle').textContent=T('title');
  $('hSub').textContent=T('sub');
  $('langBtn').textContent=T('btn');
  const dt=dayType(),dn=T('days')[hkD()];
  const onWd=dt==='wd'?'on':'off',onWe=dt==='we'?'on':'off';
  const auto=!forceDay;
  $('hMeta').innerHTML=`
    <span class="day-badge ${onWd}" onclick="setDay('wd')" title="${T('tap')}">üìÖ ${T('wd')}${dt==='wd'&&auto?' ‚úì':''}</span>
    <span class="day-badge ${onWe}" onclick="setDay('we')" title="${T('tap')}">üéâ ${T('we')}${dt==='we'&&auto?' ‚úì':''}</span>
    <div class="day-auto">${auto
      ?`ü§ñ ${T('auto')} ¬∑ ${dn} ¬∑ ${dt==='wd'?T('wdF'):T('weF')}`
      :`<a onclick="setDay(null)">${T('reset')}</a> ¬∑ ${dt==='wd'?T('wdF'):T('weF')}`
    }</div>`;
}
function setDay(v){forceDay=(forceDay===v)?null:v;rAll()}

/* ==============================================================
   RENDER ‚Äî DASHBOARD CARDS
   ============================================================== */
function rDash(){
  $('grid').innerHTML=R.map(r=>{
    const ts=times(r),ps=ts.map(pT),ni=nextI(ts),loc=r[lang],n=nowM(),c=cMap[r.color];
    let body='';

    // Check in-transit bus
    function transitHTML(idx){
      if(idx<0||idx>=ps.length)return '';
      const p=ps[idx],dep=n-p.tot;
      if(dep>=0&&dep<r.tr){
        const arr=addM(p.disp,r.tr),left=r.tr-dep;
        return `<div class="card-transit">üöå <span>${T('transit')}</span>&nbsp;‚Üí&nbsp;${T('eta')} <b>${arr}</b>&nbsp;(${left} ${lang==='zh'?'ÂàÜÈêò':'min'})</div>`;
      }
      return '';
    }

    if(ni===-1){
      const first=pT(ts[0]);
      const trH=transitHTML(ps.length-1);
      body=`${trH}<div class="card-ended"><div class="ended-msg">üò¥ ${T('ended')}</div><div class="ended-first">${T('tmr')}Ôºö<b>${first.disp}</b></div></div>`;
    }else{
      const nx=ps[ni],diff=nx.tot-n;
      let cdC,cdT;
      if(diff<=0){cdC='cd-now';cdT='üöå '+T('soon')}
      else if(diff<=3){cdC='cd-soon';cdT=diff+' '+T('inMin')}
      else{cdC='cd-norm';cdT=diff+' '+T('inMin')}
      const arrT=addM(nx.disp,r.tr);
      const trH=ni>0?transitHTML(ni-1):'';
      const later=[];
      for(let j=ni+1;j<Math.min(ni+4,ps.length);j++)later.push(ps[j].disp);

      body=`${trH}
        <div class="next-label"><span class="pulse" style="background:${c};box-shadow:0 0 10px ${c}"></span>${T('next')}</div>
        <div class="next-time">${nx.disp}${nx.sp?'<span class="star">‚òÖ</span>':''}</div>
        <div class="countdown ${cdC}">${cdT}</div>
        <div class="card-arr">üèÅ ${T('eta')} <b>~${arrT}</b></div>
        ${later.length?`<div class="card-later">${T('after')}<div class="later-row">${later.map(l=>'<span>'+l+'</span>').join('')}</div></div>`:''}`;
    }
    return `<div class="route-card" style="--rc:${c}" onclick="selTab('${r.id}')">
      <div class="card-head">
        <div class="card-dir">${loc.f} <span class="arr">${T('to')}</span> ${loc.t}</div>
        <div class="card-tag">‚è± ${r.tr} ${T('ride')}</div>
      </div>${body}</div>`;
  }).join('');
}

/* ==============================================================
   RENDER ‚Äî TIMETABLE TABS + GRID
   ============================================================== */
function rTabs(){
  $('secT').textContent=T('fullTT');
  $('tabs').innerHTML=R.map(r=>{
    const loc=r[lang],on=r.id===activeTab?'on':'';
    return `<button class="tab ${on}" data-c="${r.color}" onclick="selTab('${r.id}')">${loc.f} ${T('to')} ${loc.t}</button>`;
  }).join('');
}

function rGrid(){
  const r=R.find(x=>x.id===activeTab);
  if(!r){$('ttBody').innerHTML='';return}
  const ts=times(r),ps=ts.map(pT),ni=nextI(ts),loc=r[lang],n=nowM();
  const dayL=dayType()==='wd'?T('wdF'):T('weF');

  const chips=ps.map((p,i)=>{
    let cls='chip';
    const isPast=ni===-1||i<ni;
    if(i===ni&&ni!==-1){cls+=' next'}
    else if(isPast){
      const dep=n-p.tot;
      cls+=(dep>=0&&dep<r.tr)?' transit':' past';
    }
    if(p.sp)cls+=' special';
    return `<span class="${cls}">${p.sp?'<span class="s">‚òÖ </span>':''}${p.disp}</span>`;
  }).join('');

  $('ttBody').innerHTML=`
    <div class="tt-info">${loc.f} ${T('to')} ${loc.t}„ÄÄ¬∑„ÄÄ${dayL}„ÄÄ¬∑„ÄÄ‚è± ${r.tr} ${T('ride')}</div>
    <div class="legend">
      <span><span class="dot" style="background:var(--amber)"></span>${T('lgNx')}</span>
      <span><span class="dot" style="background:var(--green)"></span>${T('lgTr')}</span>
      <span><span class="dot" style="background:var(--t4);opacity:.3"></span>${T('lgDep')}</span>
      <span><span class="s" style="color:var(--amber);font-size:12px">‚òÖ</span> ${T('lgSp')}</span>
    </div>
    <div class="time-grid">${chips}</div>`;
}

function selTab(id){
  activeTab=id;rTabs();rGrid();
  document.querySelector('.tt-section').scrollIntoView({behavior:'smooth',block:'start'});
}

/* ==============================================================
   RENDER ‚Äî FOOTER
   ============================================================== */
function rFoot(){
  $('notes').innerHTML=`<h3>${T('notes')}</h3><ul>
    <li>${T('n1')}</li><li>${T('n2')}</li>
    ${T('n3')?'<li>'+T('n3')+'</li>':''}
    <li>${T('n5')}</li>
    <li>${T('n4')}</li></ul>`;
  const hl=lang==='zh'?'ÁÆ°ÁêÜËôïÁÜ±Á∑ö':'Hotline';
  $('contactInfo').textContent=hl+': Villa Concerto 26311380 / 26308106 ¬∑ Villa Rhapsody 26308107 / 26308100';
}

/* ==============================================================
   RENDER ALL
   ============================================================== */
function rAll(){rHero();rDash();rTabs();rGrid();rFoot()}

/* ==============================================================
   LANGUAGE TOGGLE
   ============================================================== */
function toggleLang(){
  lang=lang==='zh'?'en':'zh';
  try{localStorage.setItem('sbLang',lang)}catch(e){}
  rAll();
}

/* ==============================================================
   FONT SIZE TOGGLE
   ============================================================== */
function toggleFont(){
  largeFont=!largeFont;
  try{localStorage.setItem('sbLargeFont',largeFont)}catch(e){}
  document.body.classList.toggle('font-large',largeFont);
}

/* ==============================================================
   INIT
   ============================================================== */
(async function init(){
  try{
    const resp=await fetch('shuttle_bus_schedule.json');
    const data=await resp.json();
    R=data.routes.map((route,i)=>{
      if(i>=ROUTE_META.length)return null;
      return{
        ...ROUTE_META[i],
        wd:flattenTimes(route.schedule.weekday.times),
        we:flattenTimes(route.schedule.weekend.times)
      };
    }).filter(Boolean);
  }catch(e){console.error('Failed to load schedule JSON',e)}
  rClock();rAll();
  setInterval(rClock,1000);
  setInterval(()=>{rDash();rGrid()},15000);
})();
</script>
</body>
</html>
